@* @using Microsoft.AspNetCore.Identity *@
@* @model Microsoft.AspNetCore.Identity.IdentityRole *@
@{
    ViewData["Title"] = "GetAll";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h2>Roles</h2>
        </div>
    </div>
    <hr />
    <div class="row">
        <div class="col-md-12">
            <button type="button" class="btn btn-success" id="btnAdd">+</button>
        </div>
    </div>
    <br />

    @* @if (Model.Count > 0)
    { *@
    <div class="row">
        <div class="col-md-12 table-responsive">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <td style="display: none;">id</td>
                        <th class="text-center">Asignar Rol</th>
                        <th class="text-center">Nombre Rol</th>
                        <th class="text-center">Editar Rol</th>
                        <th class="text-center">Eliminar Rol</th>
                    </tr>
                </thead>
                <tbody id="tBodyRol">
                    @* @foreach (var role in Model)
                    { *@
                    @* <tr>
                    <td style="text-align: center; vertical-align: middle;"><a class="btn btn-success glyphicon" href="@Url.Action("Asignar", "Rol", new { IdRole = role.Id, Name= role.Name})"><i class="bi bi-person-gear" style="color: ivory"></i></a></td>
                    <td style="display: none;">@role.Id </td>

                    <td>@role.Name</td> *@

                    @*IdRole es un Parametro tipo Guid*@
                    @* <td style="text-align: center; vertical-align: middle;"><a class="btn btn-warning glyphicon" href="@Url.Action("Form", "Rol", new { IdRole = role.Id, Name= role.Name})"><i class="bi bi-pencil" style="color: ivory"></i></a></td>
                    <td style="display: none;">@role.Id </td>     *@                                                                                 @*La variable IdRole se llama así porque esta declarada como parametro en La Action del Contolador tal cual*@

                    @*IdRole es un Parametro tipo Guid*@
                    @* <td style="text-align: center; vertical-align: middle;"><a class="btn btn-danger glyphicon glyphicon-trash" href="@Url.Action("Delete", "Rol",  new { IdRole = role.Id })" onclick="return confirm('¿Estas seguro que deseas eliminar el rol?');"><i class="bi bi-trash" style="color: mintcream"></i></a></td>
                    </tr> *@
                    @* } *@
                </tbody>
            </table>

        </div>
    </div>
    @* }
    else
    {
    <div class="alert alert-danger alert-dismissible" role="alert">
    No existen registros.
    </div>
    } *@
</div>


<div class="container">
    <div class="modal fade" id="modalAgregar" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Rol</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="col-md-12" style="display: none;">
                        @* @Html.TextBoxFor(model => model.Id, new { @class = "form-control", @id = "txtIdRol" }) *@
                        <input type="text" class="form-control" id="txtIdRol" />
                    </div>

                    <div class="col-md-12">
                        @Html.Label("Nombre del Rol:")
                        @* @Html.TextBoxFor(model => model.Name, new { @class = "form-control", @id = "txtNombre", @placeholder = "ejem. Administrador" })
                        @Html.TextBoxFor(model => model.Id, new { @class = "visually-hidden" }) *@
                        <input type="text" class="form-control" id="txtNombre" placeholder="ejem. Administrador" />
                        <label id="lblNombre"></label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success" id="btnGuardar">Guardar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="modal fade" id="modalAsignar" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Rol</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="col-md-12" style="display: none;">
                        <input type="text" class="form-control" id="txtIdRole" />
                    </div>
                    <div class="col-md-12">
                        <select id="ddlAsignar" class="form-control">
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success" id="btnAsignar">Guardar</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            GetAll();
        });

        function GetAll() {
            $.ajax({
                type: 'GET',
                url: '@Url.Action("GetAllRoles")',
                success: function (result) {
                    $('#tBodyRol').empty();

                    $.each(result, function (i, rol) {
                        var fila =
                            '<tr>'
                            + '<td style="text-align: center; vertical-align: middle;"><button type="button" class="btn btn-info" id="btnAsignar" onclick="Asignar(this)" value="' + rol.id + '">Asignar</button></td>'
                            // + '<td style="display: none;"></td>'
                            + '<td style="text-align: center;">' + rol.name + '</td>'
                            + '<td style="text-align: center; vertical-align: middle;"><button type="button" class="btn btn-warning" id="btnUpdate" onclick="Actualizar(this)"  value="' + rol.id + '">Editar</button></td>'
                            // + '<td style="display: none;"></td>'
                            + '<td style="text-align: center; vertical-align: middle;"><button type="button" class="btn btn-danger" onclick="Delete(this)"  value="' + rol.id + '">Eliminar</button></td>'
                            + '</tr>';
                        $('#tBodyRol').append(fila);
                    });
                },
                error: function (result) {
                    alert('Error en la consulta.');
                }
            });
        };

        function Usuarios() {
            $.ajax({
                type: 'GET',
                url: '@Url.Action("GetAllUsuarios")',
                success: function (result) {
                    $('#ddlAsignar').append('<option value="' + 0 + '">' + 'Seleccione una opción' + '</option>');
                    $.each(result.objects, function (i, user) {
                        var select =
                            '<option value="' + user.idUsuario + '">' + user.userName + '</option>';
                        $("#ddlAsignar").append(select);
                    });
                },
                error: function (result) {
                    alert('Error en la consulta.');
                }
            });
        };

        $('#btnAdd').click(function () {
            $("#txtIdRol").val("");
            $("#txtNombre").val("");
            $('#modalAgregar').modal('show');
        });

        $('#btnGuardar').click(function () {
            $.ajax({
                type: 'POST',
                url: '@Url.Action("Form")',
                data: $('#myForm').serialize(),
                dataType: 'json',
                success: function (result) {
                    $('#modalAgregar').modal('hide');

                    $('#tBodyRol').empty();

                    GetAll();
                },
                error: function (result) {
                    alert('Error en la consulta.');
                }
            });
        });

        function Actualizar(idRol) {
            $.ajax({
                url: '@Url.Action("GetByIdRol")',
                data: { IdRole: idRol.value },
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    $('#txtIdRol').val(data.object.roleId);
                    $('#txtNombre').val(data.object.name);
                    $('#modalAgregar').modal('show');

                },
                error: function () {
                    alert('Disculpe, existió un problema');
                }
            });
        };

        function Delete(idRol) {
            var checkconfirm = confirm('¿Estas seguro de eliminarlo?');
            if (checkconfirm == true) {
                $.ajax({
                    url: '@Url.Action("Delete")',
                    data: { IdRole: idRol.value },
                    type: 'POST',
                    dataType: 'json',
                    success: function () {
                        $('#tBodyRol').empty();
                        GetAll();
                    },
                    error: function () {
                        alert('Disculpe, existió un problema');
                    }
                });
            } else {
                return false;
            }

        };



        function Asignar(idRol) {
            $.ajax({
                url: '@Url.Action("Asignar")',
                data: { IdRole: idRol.value },
                type: 'GET',
                dataType: 'json',
                success: function (result) {
                    $('#txtIdRole').val(result.rol.roleId);
                    $('#ddlAsignar').val(result.identityUsers.roleId);
                    $('#modalAsignar').modal('show');
                },
                error: function () {
                    alert('Disculpe, existió un problema');
                }
            });
        };
    </script>

}

